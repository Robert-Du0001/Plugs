;(function(win,builtIn){function factory(base){this.base=Object.assign({},builtIn.__base,base);this.create=function(newOption){var obitem=++builtIn.__global.item;builtIn.__global.option[obitem]=Object.assign({},builtIn.__option,newOption);builtIn.__global.fileQueue[obitem]=new Array();var option=builtIn.__global.option[obitem],fileQueue=builtIn.__global.fileQueue[obitem];var regex=option.type&&new RegExp(builtIn.__regexFileType(option.type));var picker=document.getElementById(option.pick);picker.onclick=function(){if(option.maxNum>fileQueue.length){if(!this.getElementsByTagName('input').length){fileBox=document.createElement('input');fileBox.type='file';fileBox.accept=option.type;fileBox.multiple=option.multiple?'multiple':'';fileBox.style.display='none';this.appendChild(fileBox)}fileBox.onclick=function(event){event.stopPropagation()}fileBox.click();fileBox.onchange=function(){var files=this.files;for(var item in files){if(!isNaN(item)){if(builtIn.__issetFile(fileQueue,files[item].name)){option.errorInfo('已经存在相同文件'+files[item].name);continue}if(option.maxSize&&files[item].size>option.maxSize){option.errorInfo('文件'+files[item].name+'尺寸过大');continue}if(regex&&!regex.test(files[item].type)){option.errorInfo('文件'+files[item].name+'类型不符');continue}if(fileQueue.length>=option.maxNum){throw new Error('文件数量超出设置长度，不再加入队列');break}files[item].id=builtIn.__createFileId();fileQueue.push(files[item]);option.queue(files[item])}}}}}}this.getDataUrl=function(file,backcall){var fr=new FileReader();fr.readAsDataURL(file);fr.onload=function(){backcall(this.result)};fr.onerror=function(){backcall(false)};fr.onloadend=function(){delete fr}}this.removeFile=function(id){var files=builtIn.__global.fileQueue;outer:for(var i in files){for(var j in files[i]){if(id==files[i][j].id){files[i].splice(j,1);break outer}}}}this.uploade=function(){var base=this.base;if(base.server){var formData=new FormData(),files=builtIn.__global.fileQueue,options=builtIn.__global.option;for(var i in base.formData)formData.append(i,base.formData[i]);for(var i in files)for(var j in files[i])formData.append(options[i].name+i+j,files[i][j]);base.beforeSend();var request=new XMLHttpRequest();request.onreadystatechange=function(){if(request.readyState===4){if(request.status==200){base.success(request.responseText)}else{base.fail(request.status)}base.always()}}request.upload.addEventListener('progress',function(e){if(e.lengthComputable){var percent=Math.floor(e.loaded/e.total*100);if(percent<=100)base.process(percent)}},false);request.open(base.method,base.server,true);request.send(formData)}}this.addFormData=function(data){Object.assign(this.base.formData,data)}}typeof FileReader!=='undefined'&&typeof FormData!=='undefined'&&(win[builtIn.__info.plug]=factory)})(window,{__info:{version:'2.0.1',plug:'muldimUploader',author:'Robert Du'},__global:{item:-1,option:{},fileQueue:new Array(),},__base:{server:'',method:'POST',formData:{},process:function(n){},beforeSend:function(){},success:function(d){},fail:function(xhr){},always:function(){}},__option:{pick:'',multiple:false,type:'',maxNum:3,maxSize:'',name:'file',queue:function(f){},errorInfo:function(i){}},__createFileId:function(){var id=Math.floor(Math.random()*1000000),files=this.__global.fileQueue;for(var i in files)for(var j in files[i])if(id==files[i][j].id)this.__createFileId();return id},__issetFile:function(files,name){for(var item in files){if(name==files[item].name)return true}return false},__regexFileType:function(type){var typeArr=type.split(',');if(typeArr.length==1)return type;else if(typeArr.length>1)return typeArr.join('|')}});